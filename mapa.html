<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zonas Inundables y Cauces en Comunitat Valenciana</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8f9fa;
            font-weight: 400;
            line-height: 1.5;
        }

        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 1rem 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: relative;
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 700;
            letter-spacing: -0.02em;
        }

        .emergency-corner {
            position: absolute;
            top: 0.5rem;
            right: 1rem;
            background: #dc3545;
            color: white;
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .container {
            display: flex;
            height: calc(100vh - 70px);
        }

        .sidebar {
            width: 260px;
            background: white;
            padding: 1rem 0.8rem;
            box-shadow: 2px 0 10px rgba(0,0,0,0.08);
            overflow-y: auto;
        }

        .map-container {
            flex: 1;
            position: relative;
        }

        #map {
            height: 100%;
            width: 100%;
        }

        .geolocate-btn-map {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 0.6rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
            font-family: 'Inter', sans-serif;
        }

        .geolocate-btn-map:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
        }

        .panel-section {
            margin-bottom: 1.2rem;
        }

        .panel-title {
            font-size: 1rem;
            font-weight: 700;
            color: #1e3c72;
            margin-bottom: 0.7rem;
            padding-bottom: 0.4rem;
            border-bottom: 2px solid #e9ecef;
            text-align: center;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
            padding: 0.4rem;
            border-radius: 6px;
            background: #f8f9fa;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 3px;
            margin-right: 10px;
            border: 1px solid;
        }

        .legend-text {
            font-size: 0.85rem;
            color: #495057;
            font-weight: 500;
        }

        .safety-tips {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            border-radius: 6px;
            padding: 0.7rem;
        }

        .safety-tips ul {
            list-style: none;
            padding-left: 0;
        }

        .safety-tips li {
            padding: 0.2rem 0;
            font-size: 0.75rem;
            color: #0c5460;
            line-height: 1.3;
            font-weight: 500;
            text-align: center;
        }

        .safety-tips li:before {
            content: "‚Ä¢";
            color: #17a2b8;
            font-weight: bold;
            display: inline-block;
            width: 0.8em;
            margin-left: -0.8em;
        }

        .links-section {
            text-align: center;
        }

        .links-section a {
            display: block;
            color: #1e3c72;
            text-decoration: none;
            font-size: 0.8rem;
            padding: 0.3rem 0;
            transition: color 0.2s;
            font-weight: 500;
        }

        .links-section a:hover {
            color: #dc3545;
        }

        .btn-share {
            background: linear-gradient(135deg, #6f42c1 0%, #e83e8c 100%);
            color: white;
            border: none;
            padding: 0.6rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 0.8rem;
            box-shadow: 0 2px 8px rgba(111, 66, 193, 0.3);
            font-family: 'Inter', sans-serif;
        }

        .btn-share:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(111, 66, 193, 0.4);
        }

        .footer {
            background: #343a40;
            color: white;
            padding: 0.6rem 1rem;
            text-align: center;
            font-size: 0.75rem;
            font-weight: 400;
        }

        .footer a {
            color: #17a2b8;
            text-decoration: none;
            font-weight: 500;
        }

        .footer a:hover {
            text-decoration: underline;
        }

        /* Estilo para el marcador de ubicaci√≥n */
        .user-location-marker {
            background: #007bff;
            border: 3px solid white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            box-shadow: 0 2px 10px rgba(0, 123, 255, 0.9);
        }

        .user-location-pulse {
            background: rgba(0, 123, 255, 0.4);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            position: absolute;
            left: -10px;
            top: -10px;
            animation: pulse 2s infinite;
        }

        /* Animaci√≥n para el marcador de ubicaci√≥n */
        @keyframes pulse {
            0% { transform: scale(0.8); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.5; }
            100% { transform: scale(0.8); opacity: 1; }
        }

        /* Control de capas m√°s peque√±o */
        .leaflet-control-layers {
            margin-top: 5px !important;
            font-size: 0.8rem !important;
            font-family: 'Inter', sans-serif !important;
        }

        .leaflet-control-layers-toggle {
            width: 28px !important;
            height: 28px !important;
        }

        .leaflet-control-layers-expanded {
            padding: 8px !important;
            max-width: 200px !important;
            border-radius: 6px !important;
        }

        .leaflet-control-layers label {
            font-size: 0.8rem !important;
            margin-bottom: 4px !important;
            font-weight: 500 !important;
        }

        /* Modal de permisos */
        .permission-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            font-family: 'Inter', sans-serif;
        }

        .permission-content {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            text-align: center;
            max-width: 380px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }

        .permission-content h3 {
            font-size: 1.2rem;
            font-weight: 700;
            color: #1e3c72;
            margin-bottom: 0.8rem;
        }

        .permission-content p {
            font-size: 0.9rem;
            color: #495057;
            margin-bottom: 1.2rem;
            line-height: 1.4;
        }

        .permission-buttons {
            display: flex;
            gap: 0.8rem;
            justify-content: center;
        }

        .permission-btn {
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Inter', sans-serif;
        }

        .permission-btn.allow {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }

        .permission-btn.deny {
            background: #6c757d;
            color: white;
        }

        .permission-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
                height: auto;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
                padding: 1rem;
            }
            
            .map-container {
                height: 400px;
            }
            
            .header h1 {
                font-size: 1.3rem;
            }
            
            .emergency-corner {
                position: static;
                display: inline-block;
                margin-top: 0.5rem;
                font-size: 0.7rem;
            }

            .panel-section {
                margin-bottom: 1rem;
            }

            .permission-content {
                margin: 1rem;
                padding: 1.2rem;
            }
        }

        @media (max-width: 480px) {
            .header {
                padding: 0.8rem 1rem;
            }
            
            .header h1 {
                font-size: 1.2rem;
            }
            
            .sidebar {
                padding: 0.8rem;
            }
            
            .panel-section {
                margin-bottom: 0.8rem;
            }

            .btn-share {
                padding: 0.5rem 0.8rem;
                font-size: 0.8rem;
            }

            .permission-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- Modal de permisos -->
    <div class="permission-modal" id="permissionModal">
        <div class="permission-content">
            <h3>Permiso de Ubicaci√≥n</h3>
            <p>Para mostrar las zonas de riesgo cerca de tu ubicaci√≥n, necesitamos tu permiso para acceder a la geolocalizaci√≥n. Esto nos ayudar√° a proporcionarte informaci√≥n m√°s relevante y precisa.</p>
            <div class="permission-buttons">
                <button class="permission-btn allow" id="allowLocation">Permitir Ubicaci√≥n</button>
                <button class="permission-btn deny" id="denyLocation">Continuar sin Ubicaci√≥n</button>
            </div>
        </div>
    </div>

    <header class="header">
        <h1>Zonas Inundables y Cauces en Comunitat Valenciana</h1>
        <div class="emergency-corner">
            N¬∫ Emergencias: 112
        </div>
    </header>

    <div class="container">
        <aside class="sidebar">
            <div class="panel-section">
                <div class="panel-title">Zonas de Riesgo</div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ff6b6b; border-color: #dc3545;"></div>
                    <div class="legend-text">Zonas Inundables</div>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #4ecdc4; border-color: #17a2b8;"></div>
                    <div class="legend-text">Cauces de R√≠os</div>
                </div>
            </div>

            <div class="panel-section">
                <div class="panel-title">Consejos de Seguridad</div>
                <div class="safety-tips">
                    <ul>
                        <li>No cruce cauces inundados</li>
                        <li>Al√©jese de zonas inundables</li>
                        <li>No salgas si no es necesario</li>
                        <li>No bajes a s√≥tanos o garajes</li>
                        <li>Desconecta la luz si entra agua</li>
                        <li>Escucha las indicaciones oficiales</li>
                    </ul>
                </div>
            </div>

            <div class="panel-section links-section">
                <div class="panel-title">Enlaces de Inter√©s</div>
                <a href="https://www.aemet.es/es/portada" target="_blank">üå¶Ô∏è AEMET - Meteorolog√≠a</a>
                <a href="https://www.proteccioncivil.es/" target="_blank">üõ°Ô∏è Protecci√≥n Civil</a>
                
                <button class="btn-share" id="share-btn">
                    Compartir
                </button>
            </div>
        </aside>

        <div class="map-container">
            <div id="map"></div>
            <button class="geolocate-btn-map" id="geolocate-btn-map">
                üìç Mi Ubicaci√≥n
            </button>
        </div>
    </div>

    <footer class="footer">
        <div>
            <strong>Fuente:</strong> IDEV y MITECO | 
            <strong>Aviso legal:</strong> Informaci√≥n informativa - Consulte fuentes oficiales
        </div>
    </footer>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Mostrar modal de permisos al cargar la p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            const permissionModal = document.getElementById('permissionModal');
            permissionModal.style.display = 'flex';
            
            // Verificar si ya tenemos permisos
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function() {
                        // Ya tiene permisos, ocultar modal
                        permissionModal.style.display = 'none';
                        locateUser();
                    },
                    function() {
                        // No tiene permisos, mostrar modal
                        permissionModal.style.display = 'flex';
                    }
                );
            }
        });

        // Inicializar mapa
        var map = L.map('map').setView([39.4699, -0.3763], 10);

        // Variables globales
        var allLayers = [];
        var userMarker = null;
        var valenciaBounds = null;

        // Capas base
        var openStreetMap = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors',
            name: 'OpenStreetMap'
        });

        var satelliteMap = L.tileLayer('https://api.maptiler.com/maps/satellite/{z}/{x}/{y}.jpg?key=khpYaWwMTabvpR0t8ghe', {
            attribution: '¬© MapTiler ¬© OpenStreetMap contributors',
            name: 'Sat√©lite'
        });

        var brightMap = L.tileLayer('https://api.maptiler.com/maps/bright-v2/{z}/{x}/{y}.png?key=khpYaWwMTabvpR0t8ghe', {
            attribution: '¬© MapTiler ¬© OpenStreetMap contributors',
            name: 'Claro'
        });

        // A√±adir capa base por defecto
        openStreetMap.addTo(map);

        // Control de capas base (colapsado debajo de zoom)
        var baseMaps = {
            "OpenStreetMap": openStreetMap,
            "Sat√©lite": satelliteMap,
            "Claro": brightMap
        };

        var layersControl = L.control.layers(baseMaps, null, { 
            position: 'topleft',
            collapsed: true
        }).addTo(map);

        // Funci√≥n para limitar el mapa a la Comunidad Valenciana
        function limitMapToValencia() {
            if (valenciaBounds) {
                map.setMaxBounds(valenciaBounds);
                map.on('drag', function() {
                    map.panInsideBounds(valenciaBounds, { animate: false });
                });
            }
        }

        // Funci√≥n para crear marcador de ubicaci√≥n redondo y llamativo
        function updateUserLocation(position) {
            var latlng = [position.coords.latitude, position.coords.longitude];
            
            // Centrar mapa en la ubicaci√≥n
            map.setView(latlng, 16);
            
            // Eliminar marcador anterior si existe
            if (userMarker) {
                map.removeLayer(userMarker);
            }
            
            // Crear marcador redondo y llamativo
            userMarker = L.marker(latlng, {
                icon: L.divIcon({
                    className: 'user-location-marker',
                    html: '<div class="user-location-pulse"></div>',
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                })
            }).addTo(map);
            
            // Popup simple
            userMarker.bindPopup('<strong>Est√°s aqu√≠</strong>').openPopup();
        }

        // Funci√≥n para geolocalizaci√≥n
        function locateUser() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        updateUserLocation(position);
                    },
                    function(error) {
                        console.log('Geolocalizaci√≥n denegada o no disponible:', error.message);
                        map.setView([39.4699, -0.3763], 10);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 60000
                    }
                );
            } else {
                console.log('La geolocalizaci√≥n no es soportada por su navegador');
            }
        }

        // Cargar capa de Comunidad Valenciana primero para establecer l√≠mites
        function loadValenciaBoundary() {
            return fetch('geojson/comunidad_valenciana.geojson')
                .then(response => {
                    if (!response.ok) throw new Error('No se pudo cargar el l√≠mite');
                    return response.json();
                })
                .then(data => {
                    var layer = L.geoJSON(data, {
                        style: {
                            fillColor: 'transparent',
                            weight: 2,
                            opacity: 0.8,
                            color: '#495057',
                            fillOpacity: 0
                        }
                    });
                    
                    valenciaBounds = layer.getBounds();
                    layer.addTo(map);
                    limitMapToValencia();
                    
                    return layer;
                })
                .catch(error => {
                    console.warn('Error cargando l√≠mite de Comunidad Valenciana:', error);
                    valenciaBounds = L.latLngBounds(
                        L.latLng(37.5, -1.5),
                        L.latLng(41.0, 0.5)
                    );
                    limitMapToValencia();
                    return null;
                });
        }

        // Funci√≥n para cargar otras capas GeoJSON
        function loadGeoJSON(url, style, popupTemplate, layerName) {
            return fetch(url)
                .then(response => {
                    if (!response.ok) return null;
                    return response.json();
                })
                .then(data => {
                    if (!data) return null;
                    
                    var layer = L.geoJSON(data, {
                        style: style,
                        onEachFeature: function(feature, layer) {
                            if (feature.properties && popupTemplate) {
                                var popupContent = popupTemplate(feature.properties);
                                layer.bindPopup(popupContent);
                            }
                        }
                    });
                    
                    allLayers.push(layer);
                    layer.addTo(map);
                    return layer;
                })
                .catch(error => {
                    console.warn('Error cargando', url, error);
                    return null;
                });
        }

        // Cargar todas las capas
        Promise.all([
            loadValenciaBoundary(),
            loadGeoJSON(
                'geojson/zonas-inundables.geojson',
                {
                    fillColor: '#ff6b6b',
                    weight: 1,
                    opacity: 0.7,
                    color: '#dc3545',
                    fillOpacity: 0.3
                },
                function(props) {
                    return `
                        <strong>Zona Inundable</strong><br>
                        <strong>Riesgo:</strong> ${props.leyenda || 'Bajo'}
                    `;
                },
                'Zonas Inundables'
            ),
            loadGeoJSON(
                'geojson/cauces-rios.geojson',
                {
                    color: '#17a2b8',
                    weight: 2,
                    opacity: 0.7,
                    fillColor: '#4ecdc4',
                    fillOpacity: 0.2
                },
                function(props) {
                    return `
                        <strong>Cauce de R√≠o</strong><br>
                        ${props.nombre ? `<strong>Nombre:</strong> ${props.nombre}<br>` : ''}
                        ${props.NOMBRE ? `<strong>Nombre:</strong> ${props.NOMBRE}<br>` : ''}
                    `;
                },
                'Cauces de R√≠os'
            )
        ])
        .then(layers => {
            console.log('Capas cargadas');
            
            var validLayers = layers.filter(layer => layer !== null);
            if (validLayers.length > 0) {
                var group = new L.featureGroup(validLayers);
                if (valenciaBounds) {
                    map.fitBounds(valenciaBounds);
                } else {
                    map.fitBounds(group.getBounds());
                }
            }
        });

        // Control de escala
        L.control.scale({ position: 'bottomleft' }).addTo(map);

        // Event listeners
        document.getElementById('geolocate-btn-map').addEventListener('click', locateUser);

        document.getElementById('share-btn').addEventListener('click', function() {
            if (navigator.share) {
                navigator.share({
                    title: 'Zonas Inundables y Cauces en Comunitat Valenciana',
                    text: 'Consulta las zonas de riesgo de inundaci√≥n en la Comunidad Valenciana',
                    url: window.location.href
                });
            } else {
                const url = window.location.href;
                const text = 'Zonas Inundables y Cauces en Comunitat Valenciana - Consulta las zonas de riesgo de inundaci√≥n';
                const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(text + ' ' + url)}`;
                window.open(whatsappUrl, '_blank');
            }
        });

        // Manejar permisos de ubicaci√≥n
        document.getElementById('allowLocation').addEventListener('click', function() {
            document.getElementById('permissionModal').style.display = 'none';
            locateUser();
        });

        document.getElementById('denyLocation').addEventListener('click', function() {
            document.getElementById('permissionModal').style.display = 'none';
            map.setView([39.4699, -0.3763], 10);
        });

    </script>
</body>
</html>